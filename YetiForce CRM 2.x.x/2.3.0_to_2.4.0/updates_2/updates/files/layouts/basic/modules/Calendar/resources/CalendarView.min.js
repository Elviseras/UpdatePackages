
jQuery.Class("Calendar_CalendarView_Js",{currentInstance:false,getInstanceByView:function(){var b=jQuery("#currentView").val();var d=b+"View";var c=b+"_"+d+"_Js";if(typeof window[c]!="undefined"){var a=new window[c]()}else{a=new Calendar_CalendarView_Js()}return a},registerSwitches:function(){var b=jQuery("#rightPanel .quickWidget");var a=b.find(".widgetContainer input.switchBtn");app.showBtnSwitch(a);b.find(".widgetContainer").each(function(){h=jQuery(this).height();if(h>250){jQuery(this).find("div:first").slimScroll({height:"250px"})}})},registerWidget:function(){var b=this.getInstanceByView();var a=jQuery("#rightPanel .quickWidget");a.find(".switchsParent").on("switchChange.bootstrapSwitch",function(c,d){element=jQuery(this).closest(".quickWidget");if(d){element.find(".widgetContainer input.switchBtn").bootstrapSwitch("state",true)}else{element.find(".widgetContainer input.switchBtn").bootstrapSwitch("state",false)}})},registerColorField:function(b,a){var c={};c.dropdownCss={"z-index":0};c.formatSelection=function(f,d){var e=f.id;var i=b.find('option[value="'+e+'"]');d.addClass(a+"_"+e);var g="<div>"+i.text()+"</div>";return g};app.changeSelectElementView(b,"select2",c)},},{calendarView:false,calendarCreateView:false,weekDaysArray:{Sunday:0,Monday:1,Tuesday:2,Wednesday:3,Thursday:4,Friday:5,Saturday:6},renderCalendar:function(){var j=this;var k=app.getMainParams("eventLimit");if(k=="true"){k=true}else{if(k=="false"){k=false}else{k=parseInt(k)+1}}var b=app.getMainParams("weekView");var g=app.getMainParams("dayView");var a=app.getMainParams("activity_view");if(a=="Today"){a=g}else{if(a=="This Week"){a=b}else{a="month"}}var f=app.getMainParams("time_format");var c;if(f==24){f="H:mm";c="HH:mm"}else{f="h:mmt";c="hh:mm A"}var d=app.getMainParams("start_day");var i=j.weekDaysArray[d];var e=app.getMainParams("start_hour")+":00";if(app.getMainParams("switchingDays")=="workDays"){var l=app.getMainParams("hiddenDays",true)}else{var l=[]}j.getCalendarView().fullCalendar("destroy");j.getCalendarView().fullCalendar({header:{left:"month,"+b+","+g,center:"title today",right:"prev,next"},timeFormat:f,axisFormat:f,scrollTime:e,firstDay:i,defaultView:a,editable:true,slotMinutes:15,defaultEventMinutes:0,forceEventDuration:true,defaultTimedEventDuration:"01:00:00",eventLimit:k,selectable:true,selectHelper:true,hiddenDays:l,views:{basic:{eventLimit:false,}},select:function(n,m){j.selectDays(n,m);j.getCalendarView().fullCalendar("unselect")},eventDrop:function(n,o,m){j.updateEvent(n,o,m)},eventResize:function(n,o,m){j.updateEvent(n,o,m)},eventRender:function(n,m){m.find(".fc-content").popover({trigger:"hover",delay:500,title:n.title,container:"body",html:true,template:'<div class="popover calendarPopover" role="tooltip"><div class="arrow"></div><h3 class="popover-title"></h3><div class="popover-content"></div></div>',content:'<div><span class="glyphicon glyphicon-time" aria-hidden="true"></span> <label>'+app.vtranslate("JS_START_DATE")+"</label>: "+n.start.format("YYYY-MM-DD "+c)+'</div><div><span class="glyphicon glyphicon-time" aria-hidden="true"></span> <label>'+app.vtranslate("JS_END_DATE")+"</label>: "+n.end.format("YYYY-MM-DD "+c)+"</div>"+(n.lok?'<div><span class="glyphicon glyphicon-globe" aria-hidden="true"></span> <label>'+app.vtranslate("JS_LOCATION")+"</label>: "+n.lok+"</div>":"")+(n.pri?'<div><span class="glyphicon glyphicon-warning-sign" aria-hidden="true"></span> <label>'+app.vtranslate("JS_PRIORITY")+"</label>: "+app.vtranslate("JS_"+n.pri)+"</div>":"")+'<div><span class="glyphicon glyphicon-question-sign" aria-hidden="true"></span> <label>'+app.vtranslate("JS_STATUS")+"</label>: "+app.vtranslate("JS_"+n.sta)+"</div>"+(n.accname?'<div><span class="calIcon modIcon_Accounts" aria-hidden="true"></span> <label>'+app.vtranslate("JS_ACCOUNTS")+"</label>: "+n.accname+"</div>":"")+(n.linkl?'<div><span class="userIcon-'+n.linkm+'" aria-hidden="true"></span> <label>'+app.vtranslate("JS_RELATION")+"</label>: "+n.linkl+"</div>":"")+(n.procl?'<div><span class="userIcon-'+n.procm+'" aria-hidden="true"></span> <label>'+app.vtranslate("JS_PROCESS")+"</label>: "+n.procl+"</div>":"")+(n.subprocl?'<div><span class="userIcon-'+n.subprocm+'" aria-hidden="true"></span> <label>'+app.vtranslate("JS_SUB_PROCESS")+"</label>: "+n.subprocl+"</div>":"")+(n.state?'<div><span class="glyphicon glyphicon-star-empty" aria-hidden="true"></span> <label>'+app.vtranslate("JS_STATE")+"</label>: "+app.vtranslate(n.state)+"</div>":"")+'<div><span class="glyphicon glyphicon-eye-open" aria-hidden="true"></span> <label>'+app.vtranslate("JS_VISIBILITY")+"</label>: "+app.vtranslate("JS_"+n.vis)+"</div>"+(n.smownerid?'<div><span class="glyphicon glyphicon-user" aria-hidden="true"></span> <label>'+app.vtranslate("JS_ASSIGNED_TO")+"</label>: "+n.smownerid+"</div>":"")});m.find(".fc-content, .fc-info").click(function(){var r=jQuery.progressIndicator({position:"html",blockInfo:{enabled:true}});var q=$(this).closest(".fc-event");var p="index.php?module=Calendar&view=ActivityStateModal&record="+q.data("id");var o=function(t){r.progressIndicator({mode:"hide"})};var s={url:p,cb:o,};app.showModalWindow(s)})},monthNames:[app.vtranslate("JS_JANUARY"),app.vtranslate("JS_FEBRUARY"),app.vtranslate("JS_MARCH"),app.vtranslate("JS_APRIL"),app.vtranslate("JS_MAY"),app.vtranslate("JS_JUNE"),app.vtranslate("JS_JULY"),app.vtranslate("JS_AUGUST"),app.vtranslate("JS_SEPTEMBER"),app.vtranslate("JS_OCTOBER"),app.vtranslate("JS_NOVEMBER"),app.vtranslate("JS_DECEMBER")],monthNamesShort:[app.vtranslate("JS_JAN"),app.vtranslate("JS_FEB"),app.vtranslate("JS_MAR"),app.vtranslate("JS_APR"),app.vtranslate("JS_MAY"),app.vtranslate("JS_JUN"),app.vtranslate("JS_JUL"),app.vtranslate("JS_AUG"),app.vtranslate("JS_SEP"),app.vtranslate("JS_OCT"),app.vtranslate("JS_NOV"),app.vtranslate("JS_DEC")],dayNames:[app.vtranslate("JS_SUNDAY"),app.vtranslate("JS_MONDAY"),app.vtranslate("JS_TUESDAY"),app.vtranslate("JS_WEDNESDAY"),app.vtranslate("JS_THURSDAY"),app.vtranslate("JS_FRIDAY"),app.vtranslate("JS_SATURDAY")],dayNamesShort:[app.vtranslate("JS_SUN"),app.vtranslate("JS_MON"),app.vtranslate("JS_TUE"),app.vtranslate("JS_WED"),app.vtranslate("JS_THU"),app.vtranslate("JS_FRI"),app.vtranslate("JS_SAT")],buttonText:{today:app.vtranslate("JS_TODAY"),month:app.vtranslate("JS_MONTH"),week:app.vtranslate("JS_WEEK"),day:app.vtranslate("JS_DAY")},allDayText:app.vtranslate("JS_ALL_DAY"),eventLimitText:app.vtranslate("JS_MORE")});j.createAddSwitch();j.registerListViewButton()},getValuesFromSelect2:function(c,d,e){if(c.hasClass("select2-hidden-accessible")){var b=(c.select2("data"));for(var a=0;a<b.length;a++){if(e){d.push(b[a].text)}else{d.push(b[a].id)}}}return d},registerButtonSelectAll:function(){var a=$(".selectAllBtn");a.click(function(d){var c=$(this).find(".selectAll");var b=$(this).find(".deselectAll");if(c.hasClass("hide")){c.removeClass("hide");b.addClass("hide");$(this).closest(".quickWidget").find("select option").prop("selected",false)}else{$(this).closest(".quickWidget").find("select option").prop("selected",true);b.removeClass("hide");c.addClass("hide")}$(this).closest(".quickWidget").find("select").trigger("change")})},loadCalendarData:function(d){var a=jQuery.progressIndicator();var k=this;k.getCalendarView().fullCalendar("removeEvents");var j=k.getCalendarView().fullCalendar("getView");var g=j.start.format();var b=j.end.format();var i=[];var l=app.getMainParams("userDateFormat");i=k.getValuesFromSelect2($("#calendarActivityTypeList"),i);if(i.length==0){d=true}var f=[];f=k.getValuesFromSelect2($("#calendarUserList"),f);if(f.length==0){f=[app.getMainParams("current_user_id")]}f=k.getValuesFromSelect2($("#calendarGroupList"),f);var c=[];$(".calendarFilters .filterField").each(function(n){var o=$(this);if(o.attr("type")=="checkbox"){var m=o.val();var p=o.prop("checked")?1:0}else{var m=o.attr("name");var p=o.val()}c.push({name:m,value:p})});if(d==true||i.length>0){var e={module:"Calendar",action:"Calendar",mode:"getEvents",start:app.getDateInVtigerFormat(l,new Date(g)),end:app.getDateInVtigerFormat(l,new Date(b)),user:f,time:app.getMainParams("showType"),types:i,filters:c};AppConnector.request(e).then(function(m){k.getCalendarView().fullCalendar("addEventSource",m.result);a.hide()})}else{k.getCalendarView().fullCalendar("removeEvents");a.hide()}},updateEvent:function(b,f,a){var c=jQuery.progressIndicator();var e=b.start.format();var d={module:"Calendar",action:"Calendar",mode:"updateEvent",id:b.id,start:e,delta:f._data,allDay:b.allDay};AppConnector.request(d).then(function(g){c.hide();if(!g.result){Vtiger_Helper_Js.showPnotify(app.vtranslate("JS_NO_EDIT_PERMISSION"));a()}},function(g){c.hide();Vtiger_Helper_Js.showPnotify(app.vtranslate("JS_NO_EDIT_PERMISSION"));a()})},selectDays:function(f,b){var c=this;if(b.hasTime()==false){b.add(-1,"days")}f=f.format();b=b.format();var a=c.getCalendarView().fullCalendar("getView");if(a.name=="month"){var e=$("#start_hour").val();var d=$("#end_hour").val();if(e==""){e="00"}if(d==""){d="00"}f=f+"T"+e+":00";b=b+"T"+d+":00"}this.getCalendarCreateView().then(function(l){if(l.length<=0){return}var g=l.find('[name="date_start"]').data("dateFormat");var k=l.find('[name="time_start"]').data("format");if(k==24){var n="HH:mm"}else{n="hh:mm tt"}var p=Date.parse(f);var r=app.getDateInVtigerFormat(g,p);var i=p.toString(n);var j=Date.parse(b);var m=app.getDateInVtigerFormat(g,j);var q=j.toString(n);l.find('[name="date_start"]').val(r);l.find('[name="due_date"]').val(m);l.find('[name="time_start"]').val(i);l.find('[name="time_end"]').val(q);var o=new Vtiger_Header_Js();o.handleQuickCreateData(l,{callbackFunction:function(s){c.addCalendarEvent(s.result)}});jQuery(".modal-body").css({"max-height":"500px","overflow-y":"auto"})})},addCalendarEvent:function(e){var f=$(".fc-toolbar input.switchBtn").bootstrapSwitch("state");var b={};var d=$.inArray(e.activitystatus.value,["PLL_POSTPONED","PLL_CANCELLED","PLL_COMPLETED"]);if(f==true&&d>=0||f!=true&&d==-1){return false}b.id=e._recordId;b.title=e.subject.display_value;var a=Date.parse(e.date_start.display_value+"T"+e.time_start.display_value);b.start=a.toString();var g=Date.parse(e.due_date.display_value+"T"+e.time_end.display_value);var c=e.assigned_user_id.value;b.end=g.toString();b.url="index.php?module=Calendar&view=Detail&record="+e._recordId;b.activitytype=e.activitytype.value;if("on"==e.allday.value){b.allDay=true}else{b.allDay=false}b.state=e.state.value;b.vis=e.visibility.value;b.sta=e.activitystatus.value;b.className="userCol_"+e.assigned_user_id.value+" calCol_"+e.activitytype.value;this.getCalendarView().fullCalendar("renderEvent",b)},getCalendarCreateView:function(){var b=this;var a=jQuery.Deferred();if(this.calendarCreateView!==false){a.resolve(this.calendarCreateView.clone(true,true));return a.promise()}var c=jQuery.progressIndicator();this.loadCalendarCreateView().then(function(d){c.hide();b.calendarCreateView=d;a.resolve(d.clone(true,true))},function(){c.hide()});return a.promise()},loadCalendarCreateView:function(){var a=jQuery.Deferred();var d=app.getModuleName();var c="index.php?module="+d+"&view=QuickCreateAjax";var b=Vtiger_Header_Js.getInstance();b.getQuickCreateForm(c,d).then(function(e){a.resolve(jQuery(e))},function(){a.reject()});return a.promise()},getCalendarView:function(){if(this.calendarView==false){this.calendarView=jQuery("#calendarview")}return this.calendarView},registerChangeView:function(){var a=this;a.getCalendarView().find("button.fc-button:not(.listViewButton)").click(function(){a.loadCalendarData()})},getSearchParams:function(){var j=this;var f=j.getValuesFromSelect2($("#calendarActivityTypeList"),[]);var c=j.getValuesFromSelect2($("#calendarUserList"),[],true);c=j.getValuesFromSelect2($("#calendarGroupList"),c,true);var g=j.getCalendarView().fullCalendar("getView");var e=g.start.format();var b=g.end.format();var d=app.getMainParams("activityStateLabels",true);var i='["activitystatus","c","'+d[app.getMainParams("showType")].join()+'"]';i+=',["date_start","bw","'+e+","+b+'"]';if(f.length){i+=',["activitytype","e","'+f+'"]'}if(c.length){i+=',["assigned_user_id","c","'+c+'"]'}$(".calendarFilters .filterField").each(function(){var k=$(this).attr("type");if(k=="checkbox"&&$(this).prop("checked")){i+=(i!=""?",[":"[")+$(this).data("search")+"]"}});var a="index.php?module=Calendar&view=List&search_params=[["+i+"]]";return a},registerAddButton:function(){var a=this;jQuery(".calendarViewContainer .widget_header .addButton").on("click",function(b){a.getCalendarCreateView().then(function(d){var c=new Vtiger_Header_Js();c.handleQuickCreateData(d,{callbackFunction:function(e){a.addCalendarEvent(e.result)}})})})},registerListViewButton:function(){var a=this;if(app.getMainParams("showListButtonInCalendar")){var b=this.getCalendarView();jQuery('<button class="btn btn-default fc-button fc-state-default listViewButton" type="button"><span class="glyphicon glyphicon-list"></span></button>').prependTo(b.find(".fc-toolbar .fc-right")).on("click",function(d){var c=a.getSearchParams();window.location.href=c})}},createAddSwitch:function(){var c=this;var d=this.getCalendarView();var b="";if(app.getMainParams("showType")=="current"&&app.cacheGet("Calendar_showType")!="history"){b=" checked "}var a=jQuery('<span class=""><input class="switchBtn showType" type="checkbox" title="'+app.vtranslate("JS_CHANGE_ACTIVITY_TIME")+'" '+b+' data-size="small" data-handle-width="90" data-label-width="5" data-on-text="'+app.vtranslate("JS_TO_REALIZE")+'" data-off-text="'+app.vtranslate("JS_HISTORY")+'"></span>').prependTo(d.find(".fc-toolbar .fc-right")).on("switchChange.bootstrapSwitch",function(g,f){if(f){app.setMainParams("showType","current");app.cacheSet("Calendar_showType","current")}else{app.setMainParams("showType","history");app.cacheSet("Calendar_showType","history")}c.loadCalendarData()});app.showBtnSwitch(a.find(".switchBtn"));var b="";if(app.getMainParams("switchingDays")=="workDays"&&app.cacheGet("Calendar_switchingDays")!="all"){b=" checked "}var a=jQuery('<span class=""><input class="switchBtn switchingDays" type="checkbox" title="'+app.vtranslate("JS_SWITCHING_DAYS")+'" '+b+' data-size="small" data-handle-width="90" data-label-width="5" data-on-text="'+app.vtranslate("JS_WORK_DAYS")+'" data-off-text="'+app.vtranslate("JS_ALL")+'"></span>').prependTo(d.find(".fc-toolbar .fc-right")).on("switchChange.bootstrapSwitch",function(g,f){if(f){app.setMainParams("switchingDays","workDays");app.cacheSet("Calendar_switchingDays","workDays")}else{app.setMainParams("switchingDays","all");app.cacheSet("Calendar_switchingDays","all")}c.renderCalendar();c.loadCalendarData()});app.showBtnSwitch(a.find(".switchBtn"))},registerSelect2Event:function(){var a=this;$(".siteBarRight .select2").each(function(c){var b=$(this).attr("id");var e=app.cacheGet("Calendar_"+b);var d=$("#"+b);if(d.length>0&&e!=null){if(d.prop("tagName")=="SELECT"){d.val(e)}}});$(".siteBarRight .select2, .siteBarRight .filterField").off("change");app.showSelect2ElementView($("#calendarUserList"));app.showSelect2ElementView($("#calendarActivityTypeList"));app.showSelect2ElementView($("#calendarGroupList"));$(".siteBarRight .select2, .siteBarRight .filterField").on("change",function(){var b=$(this);var c=b.val();a.loadCalendarData();if(b.attr("type")=="checkbox"){c=b.is(":checked")}app.cacheSet("Calendar_"+b.attr("id"),c)})},registerCacheSettings:function(){$(".siteBarRight .filterField").each(function(b){var a=$(this).attr("id");var d=app.cacheGet("Calendar_"+a);var c=$("#"+a);if(c.length>0&&d!=null){if(c.attr("type")=="checkbox"){c.prop("checked",d)}}})},registerEvents:function(){this.renderCalendar();this.registerCacheSettings();this.registerAddButton();this.loadCalendarData(true);this.registerButtonSelectAll();this.registerChangeView()}});jQuery(document).ready(function(){var a=Calendar_CalendarView_Js.getInstanceByView();a.registerEvents();Calendar_CalendarView_Js.currentInstance=a;Calendar_CalendarView_Js.registerWidget()});